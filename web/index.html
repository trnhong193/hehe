<!DOCTYPE html>
<html>
<head>
    <title>Bản đồ EMP</title>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link rel="stylesheet" href="leaflet/leaflet.css" />
    <style>
        html, body, #map { height: 100%; width: 100%; margin: 0; padding: 0; }
    </style>
  
    <script src="qrc:///qtwebchannel/qwebchannel.js"></script>
</head>
<body>
    <div id="map"></div>

    <script src="leaflet/leaflet.js"></script>
    <script>
        var map = L.map('map').setView([21.0285, 105.8542], 13);

        L.tileLayer('tiles/vietnam_satellite/{z}/{x}/{y}.png', {
            maxZoom: 16,
            minZoom: 11,
            attribution: 'Map data &copy; Local Tiles'
        }).addTo(map);

        // --- PHẦN CẬP NHẬT ĐỂ GIAO TIẾP VỚI PYTHON ---

        // Biến toàn cục để lưu trữ đối tượng cầu nối
        var py_bridge = null;

        // Hàm này sẽ được gọi khi kênh giao tiếp sẵn sàng aka khởi tạo kênh giao tiếp 
        // Khi kết nối thành công, nó dẽ tìm đối tượng tên py_bridge(tên tự đặt và khai báo ở python)
        new QWebChannel(qt.webChannelTransport, function (channel) {
            // "py_bridge" là tên đối tượng mà chúng ta sẽ đăng ký từ phía Python
            py_bridge = channel.objects.py_bridge;
        });

        map.on('click', function(e) {
            var lat = e.latlng.lat;
            var lng = e.latlng.lng;

            // Kiểm tra xem cầu nối đã sẵn sàng chưa
            if (py_bridge) {
                // Gọi hàm onMapClicked trong đối tượng Python
                py_bridge.onMapClicked(lat, lng);
            } else {
                console.error("Lỗi: Kênh giao tiếp Python chưa sẵn sàng.");
            }
        });



        // --- PHẦN CẬP NHẬT ĐỂ VẼ ĐỐI TƯỢNG ---

        // Dùng một object để lưu trữ các layer đã vẽ, với key là ID của đối tượng
        // Điều này giúp chúng ta có thể xóa hoặc sửa chúng sau này
        var drawnLayers = {};
        var overLayer = null;  // Bien lưu layer vẽ đường bao heatmap  
        // Hàm vẽ marker cho EMP
        function addEmpMarker(lat, lon, id) {
            if (drawnLayers[id]) {
                map.removeLayer(drawnLayers[id]); // Xóa marker cũ nếu có
            }
            var marker = L.marker([lat, lon]).addTo(map);
            marker.bindPopup(`<b>Nguồn EMP</b><br>ID: ${id}`);
            drawnLayers[id] = marker;
        }

        // Hàm vẽ hình chữ nhật cho vật cản
        function addObstacleShape(lat, lon, length, width, id) {
            if (drawnLayers[id]) {
                map.removeLayer(drawnLayers[id]); // Xóa hình cũ nếu có
            }

            // --- Tính toán gần đúng tọa độ góc từ tâm và kích thước (mét) ---
            // 1 độ vĩ tuyến ~ 111.1 km
            const lat_offset = (width / 2) / 111111;
            // 1 độ kinh tuyến ~ 111.1 km * cos(vĩ độ)
            const lon_offset = (length / 2) / (111111 * Math.cos(lat * Math.PI / 180));

            var southWest = [lat - lat_offset, lon - lon_offset];
            var northEast = [lat + lat_offset, lon + lon_offset];
            var bounds = [southWest, northEast];

            var rect = L.rectangle(bounds, {color: "#3388ff", weight: 1}).addTo(map);
            rect.bindPopup(`<b>Vật cản</b><br>ID: ${id}`);
            drawnLayers[id] = rect;
        }

        function updateOverlayImage(imageUrl, latMin, lonMin, latMax, lonMax) {
        //  nhận đường dẫn đến file ảnh và tọa độ 4 góc, sau đó dùng L.imageOverlay để phủ ảnh đó lên bản đồ. opacity cho phép nhìn xuyên qua lớp heatmap. imageUrl + '?t=' + ... là một mẹo nhỏ để trình duyệt không dùng lại ảnh cũ đã cache.
            // Xóa lớp ảnh cũ nếu có
            if (overLayer) {
                map.removeLayer(overLayer);
            }

            // Tạo một timestamp để tránh cache của trình duyệt
            var imageUrlWithNoCache = imageUrl + '?t=' + new Date().getTime();
            
            var imageBounds = [[latMin, lonMin], [latMax, lonMax]];
            overLayer = L.imageOverlay(imageUrlWithNoCache, imageBounds, {
                opacity: 0.6, // Độ trong suốt
                interactive: false // Không bắt sự kiện click chuột
            }).addTo(map);
        }
    
        // --- HÀM MỚI ĐỂ LẤY BIÊN BẢN ĐỒ ---
        function getMapBounds() {
            // getMapBounds: Hàm này được Python gọi để lấy thông tin về khu vực bản đồ đang hiển thị. Sau khi lấy được, nó gọi ngược lại một hàm onMapBoundsReceived bên Python.
            var bounds = map.getBounds();
            // Gửi thông tin về Python qua bridge
            py_bridge.onMapBoundsReceived(
                bounds.getSouth(), 
                bounds.getWest(), 
                bounds.getNorth(), 
                bounds.getEast()
            );
        }
        
        

</script>
</body>
</html>